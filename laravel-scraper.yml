version: 0.2

phases:
  install:
    runtime-versions:
      php: 7.4
    commands:
      - echo Installing dependencies...
      - composer install --no-progress --no-suggest --prefer-dist --optimize-autoloader

  pre_build:
    commands:
      - echo Setting up environment variables...
      - cp .env.example .env
      - php artisan key:generate
      - echo Configuring SQLite Database...
      - mkdir -p database
      - touch database/database.sqlite
      - echo "DB_CONNECTION=sqlite" >> .env
      - echo "DB_DATABASE=$(pwd)/database/database.sqlite" >> .env
      - php artisan migrate --force

  build:
    commands:
      - echo Running Laravel tests...
      - php artisan test
      - echo Running web scraper...
      - php artisan app:scrape

artifacts:
  files:
    - storage/app/output.json
